<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>

<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="//d3js.org/queue.v1.min.js"></script>

<div id="chartContainer"></div>

<script>
    var width = 720,
            height = 720,
            outerRadius = Math.min(width, height) / 2 - 10,
            innerRadius = outerRadius - 24;

    var formatPercent = d3.format(".1%");

    var arc = d3.svg.arc()
            .innerRadius(innerRadius)
            .outerRadius(outerRadius);

    var layout = d3.layout.chord()
            .padding(.04)
            .sortSubgroups(d3.descending)
            .sortChords(d3.ascending);

    var path = d3.svg.chord()
            .radius(innerRadius);

    var svg = d3.select("#chartContainer").append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("id", "circle")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    svg.append("circle")
            .attr("r", outerRadius);

    queue()
            .defer(d3.csv, 'hoods_nyc.csv')
            .defer(d3.text, 'matrix_nyc.csv')
            .await(ready);

    function ready(error, hoods, data){
        if(error) throw error;

        var matrix = d3.csv.parseRows(data).map(function(row){
            return row.map(function(val){
                return +val;
            });
        });




        layout.matrix(matrix);

        var group = svg.selectAll(".group")
                .data(layout.groups)
                .enter().append("g")
                .attr("class", "group")
                .on("mouseover", mouseover);

        group.append("title").text(function(d, i) {
            return hoods[i].name + ": " + d.value + " bikers starting here.";
        });

        var groupPath = group.append("path")
                .attr("id", function(d, i) { return "group" + i; })
                .attr("d", arc)
                .style("fill", function(d, i) { return hoods[i].color; });

        var groupText = group.append("text")
                .attr("x", 6)
                .attr("dy", 15);

        groupText.append("textPath")
                .attr("xlink:href", function(d, i) { return "#group" + i; })
                .style('font-size', "10px")
                .text(function(d, i) { return hoods[i].name; });

        // Remove the labels that don't fit. :(
        groupText.filter(function(d, i) { return groupPath[0][i].getTotalLength() / 2 - 16 < this.getComputedTextLength(); })
                .remove();

        var chord = svg.selectAll(".chord")
                .data(layout.chords)
                .enter().append("path")
                .attr("class", "chord")
                .style("fill", function(d) { return hoods[d.source.index].color; })
                .attr("d", path);

        chord.append("title").text(function(d) {
            return hoods[d.source.index].name
                    + " → " + hoods[d.target.index].name
                    + ": " + d.source.value
                    + "\n" + hoods[d.target.index].name
                    + " → " + hoods[d.source.index].name
                    + ": " + d.target.value;
        });

        function mouseover(d, i) {
            chord.classed("fade", function(p) {
                return p.source.index != i
                        && p.target.index != i;
            });
        }

    }



</script>

</body>
</html>